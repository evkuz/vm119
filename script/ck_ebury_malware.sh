#!/bin/bash
#
# Скрипт проверяет наличие уязвимости ebury malware 
# https://security.web.cern.ch/security/advisories/windigo/windigo.shtml 
# и есть таковая есть, выдает TROUBLE
# если уязвимости нет, выдает OK
#COMMAND_NAME="lsof |grep `@/run`"
#COMMAND_OBJ="objdump -x /lib64/libkeyutils.so.1 |grep NEEDED"

#$COMMAND_OBJ
# Файл с результатами работы скрипта по хостам
#RESULT="/root/ebury_malware_list.txt"
#touch $RESULT

if [[ -z $(objdump -x /lib64/libkeyutils.so.1 |grep NEEDED | grep libstz.so) ]]; then
#   echo "NO libstz.so"
   libstz_so=1
else
#   echo "$hostname INFECTED !"
    libstz_so=0
fi

if [[ -z $(lsof | grep "@/run") ]]; then
#    echo "The host $HOSTNAME is OK"
   mal_socket=1
else
#    echo "$hostname INFECTED !"
    mal_socket=1
fi

if [[ $libstz_so = 1 && $mal_socket = 1 ]]; then
   echo "$HOSTNAME OK"
# >> $RESULT
else
   echo "$HOSTNAME TROUBLE"
# >> $RESULT
fi
